{{ $file := (.Get "file") }}
{{ $content := readFile (.Get "file") }}

{{ $first_line_contains := (.Get "first_line_contains") }}
{{ $last_line_contains := (.Get "last_line_contains") }}

{{ $show_line := false }}

{{/*if true, first or last line was not found*/}}
{{ $first_line_found := false}}
{{ $last_line_found := false}}

{{ $padding_after := (.Get "padding_after" | default "0" | int) }}

{{ $linkFile := $file }}
{{ if in $file "content/src-link/" }}
    {{ $linkFile = replace $linkFile "content/src-link/" "" }}
{{ end }}

<small class="smaller">Full source: [{{ $linkFile }}](https://github.com/ThreeDotsLabs/watermill/tree/master/{{ $linkFile }})</small>

{{ $lines := slice }}

{{ range $elem_key, $elem_val := split $content "\n" }}
    {{ if and (not $first_line_found) (in $elem_val $first_line_contains) }}
        {{ if ne $elem_key 0 }}
            {{ $lines = $lines | append "// ..." }}
        {{ end }}

        {{ $show_line = true }}
        {{ $first_line_found = true}}
    {{ end }}

    {{ if $show_line }}
        {{ $lines = $lines | append $elem_val }}
    {{ end }}

    {{ if and ($first_line_found) (in $elem_val $last_line_contains) (ne $last_line_contains "") }}
        {{ $last_line_found = true }}
    {{ end }}

    {{ if and $last_line_found $show_line }}
        {{ if gt $padding_after 0 }}
            {{ $padding_after = sub $padding_after 1}}
        {{ else }}
            {{ $lines = $lines | append "// ..." }}
            {{ $show_line = false }}
        {{ end }}
    {{ end }}
{{ end }}

{{ highlight (delimit $lines "\n") (.Get "type" | default "go") "" }}

{{if not $first_line_found }}
    {{ errorf "`first_line_contains` %s not found in %s snippet" $first_line_contains $file }}
{{end}}

{{if and (not $last_line_found) (ne $last_line_contains "") }}
    {{ errorf "`last_line_contains` %s not found in %s snippet" $last_line_contains $file }}
{{end}}